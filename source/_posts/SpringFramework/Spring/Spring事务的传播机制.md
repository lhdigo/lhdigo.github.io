---
title: Spring事务的传播机制
date: 2020-10-10 21:09:07
tags: 
	- Spring
	- 事务
categories: [SpringFramework,Spring]
---
# Spring事务的配置方式
## 1. 编程式事务管理
编程式事务管理是**侵入性**事务管理，粒度为**代码块**。

使用`TransactionTemplate`或者直接使用`PlatformTransactionManager`，对于编程式事务管理，Spring推荐使用`TransactionTemplate`。

<!--more-->

## 2. 声明式事务管理

声明式事务，**非侵入式**，建立在**AOP**之上，其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，执行完目标方法之后根据执行的情况提交或者回滚。

实现方式：配置文件中做事务声明/注解；

粒度为**方法**级别（不足）；



# Spring事务的传播机制

## 1. PROPAGATION_REQUIRED

默认的spring事务传播级别，使用该级别的特点是，如果上下文中已经存在事务，那么就加入到事务中执行，如果当前上下文中不存在事务，则新建事务执行。所以这个级别通常能满足处理大多数的业务场景。



## 2. PROPAGATION_SUPPORTS

如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。

**完全依赖外层的事务**

## 3. PROPAGATION_NOT_SUPPORTED

总是以非事务方式运行，如果当前存在事务，则把当前事务挂起。

执行完当前代码，则恢复外层事务，无论是否异常都不会回滚当前的代码

## 4. PROPAGATION_REQUIRES_NEW

创建一个新的事务，如果当前存在事务，则把当前事务挂起。当新事务执行完毕，恢复上层事务的执行。



## 5. PROPAGATION_NEVER 

以非事务方式运行，如果当前存在事务，则抛出异常。



## 6. PROPAGATION_MANDATORY

与NEVER相反，若外层无事务，则抛出异常。若当前存在事务，则加入该事务；



## 7. PROPAGATION_NESTED

如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，等价于`PROPAGATION_REQUIRED`

> 子事务回滚，父事务可选择性回滚或者不会滚
>
> 父事务回滚，子事务一定回滚

该传播机制的特点是可以保存状态保存点，当前事务回滚到某一个点，从而避免所有的嵌套事务都回滚，即各自回滚各自的，如果子事务没有把异常吃掉，基本还是会引起全部回滚。

